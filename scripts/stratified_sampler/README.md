# 1. 개요
본 모듈은 층화추출(Stratified Sampling) 기법을 구현한 샘플러입니다.  
층화추출은 모집단을 동질적인 하위 집단(층, strata)으로 분할한 후, 각 층에서 무작위로 샘플을 추출하여 전체 모집단을 대표하는 표본을 구성하는 방법입니다.  
본 접근법은 단순 무작위 추출보다 샘플의 대표성과 통계적 효율성을 향상시키는 데 유리합니다.  

본 샘플러는 **정상 거래 데이터** 를 추출하는 데 적용되며,  
**이상 거래 데이터** 는 본 샘플러를 적용하지 않고 별도로 관리합니다.  

> 참고: 이상 거래는 발생 빈도가 정상 거래에 비해 극히 적어, 통계적 샘플링 기법보다는 전량 수집 또는 별도 관리가 적합합니다.


  
# 2. 구현 배경 
관련 이슈: [[경남은행] AI 재학습간 이슈](https://github.com/interezen/ai-parent/issues/69)  
과거 프로젝트 수행 과정에서 동일한 모델 구조 및 하이퍼 파라미터 설정 하에서도 **라벨링 방식** 과 **샘플링 전략** 의 차이가 모델 성능에 유의미한 영향을 미쳤습니다.  
기존 샘플링 스크립트 `getES.py`의 정상/이상거래 라벨링 방식은 모델의 성능 저하를 초래하였습니다.    
이에 따라 각 층의 특성이 적절히 반영된 학습 데이터를 구성하기 위해 stratified_sampler를 개발했습니다.  


# 3. 정의
- **이상 거래**  
  보이스피싱, 대출사기, 자녀 사칭 등으로 피해자가 결제, 대포 계좌에 송금/이체한 것으로 추정되는 거래   
  대포 계좌에서 발생한 것으로 추정되는 결제 및 인출 거래  

- **정상 거래**  
  이상거래를 제외하고 송금/이체된 일련의 거래

- **라벨 정의**  
  - `1`: 이상 거래 
  - `0`: 정상 거래

- **라벨링 단위**  
  거래 단위(Transaction-level)로 개별 거래에 대한 라벨을 부여  
  (특정 계좌의 거래 데이터 전체를 일괄 라벨링 하지 않고, 거래별 특성을 반영하여 라벨링)

# 4. 층화 추출 작동 방식
## 4.1 층 정의
사용자는 하나 이상의 기준 변수(예: 성별, 연령대, 지역 등)를 지정하여 데이터를 층으로 분할합니다.  
층화 기준은 `stratification.yaml` 파일을 통해 정의하며, 파일 상단 주석에 작성 방법을 명시합니다.

## 4.2 비례 할당 방식
본 스크립트는 비례 할당 방식만을 지원합니다.  
이는 전체 모집단 대비 각 층의 비율에 따라 샘플 수를 할당하는 방식입니다.
전체 모집단의 특성을 정확하게 반영할 수 있습니다.  

$$n_h = \max\left(1, \left\lfloor n \times \frac{N_h}{N} \right\rfloor \right)$$

$n_h$ : 층 $h$에서 추출할 샘플 수  
$n$ : 원하는 전체 샘플 크기  
$N_h$ : 층 $h$의 모집단 크기  
$N$ : 전체 모집단 크기  

### 4.3 샘플링 절차
1. 층 분포 확인
   - 각 인덱스 별로 층화 기준 변수에 따라 데이터 분포 집계
2. 비례 기반 샘플 수 계산
   - 모집단 대비 층별 비율에 따라 샘플 수 산정
3. 각 층별 무작위 샘플링
   - 계산한 수량만큼 층별로 랜덤 샘플링
4. 샘플 결과 저장
   - Elasticsearch 인덱스에 샘플 적재
   - 기준 필드 및 시간 필드를 별도 .txt 파일로 저장하여 기록 및 검증 가능하도록 관리

### 4.4 기대 효과  
- 대표성 향상  
모집단의 다양한 하위 집단이 샘플에 적절히 반영되어 분석 결과의 일반화 가능성이 높아집니다.
- 통계적 효율성 증가   
모델이 편향된 정상 거래 샘플을 학습하지 않도록 제어합니다.
